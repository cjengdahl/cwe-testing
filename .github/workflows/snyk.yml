name: snyk security scan with cwe extraction

on:
  pull_request:
    branches:
      - main
      - develop

jobs:

  snyk-scan:
    runs-on: ubuntu-latest

    outputs:
      cwes: ${{ steps.extract-cwes.outputs.cwes }}

    steps:
      - name: checkout code
        uses: actions/checkout@master
      - name: setup snyk
        uses: snyk/actions/setup@master
      - name: setup python
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'
      - name: rum snyk code test
        run: |
          # TODO: support scanning dependencies as well with `snyk test --sarif`
          snyk code test --sarif > snyk-code-results.json || true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      - name: extract cwes from snyk results
        id: extract-cwes
        run: |
          cwe_array=$(cat snyk-code-results.json | jq '[.runs[].tool.driver.rules[].properties.cwe | select(. != null) | if type == "array" then .[] else . end]')
          echo "cwes=$cwe_array" >> $GITHUB_OUTPUT

  # example job that uses the extracted cwes
  process-cwes:
    needs: snyk-scan
    runs-on: ubuntu-latest
    if: needs.snyk-scan.outputs.cwes != '[]'

    steps:
      - name: process extracted cwes
        run: |
          echo "processing cwes: ${{ needs.snyk-scan.outputs.cwes }}"
          cwes='${{ needs.snyk-scan.outputs.cwes }}'
          echo "$cwes" | jq -r '.[]' | while read cwe; do
            echo "processing $cwe"
            # eventually sending off data to exxternal api here
          done
